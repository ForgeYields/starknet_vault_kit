FROM node:18-slim as base

# Install OpenSSL 1.1 and other necessary packages
RUN apt-get update && apt-get install -y \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Install pnpm
RUN npm install -g pnpm

# Copy package files for dependency installation
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml tsconfig.base.json ./
COPY apps/api/package.json ./apps/api/
COPY apps/indexer/package.json ./apps/indexer/
COPY libs/config/package.json ./libs/config/
COPY libs/db/package.json ./libs/db/
COPY libs/logger/package.json ./libs/logger/

# Install all dependencies (including dev dependencies for development)
RUN pnpm install

# Copy prisma schema for client generation
COPY prisma ./prisma/

# Generate Prisma client
RUN pnpm run prisma:generate

# API target for development
FROM base as api
EXPOSE 3000
CMD ["pnpm", "run", "dev:api"]

# Indexer target for development  
FROM base as indexer
CMD ["pnpm", "run", "dev:indexer"]